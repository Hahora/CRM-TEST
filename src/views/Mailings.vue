<script setup lang="ts">
import { ref, computed } from "vue";
import AppIcon from "@/components/AppIcon.vue";
import MailingsStats from "@/components/mailings/MailingsStats.vue";
import MailingsFilters from "@/components/mailings/MailingsFilters.vue";
import type { MailingsFilters as TFilters } from "@/components/mailings/MailingsFilters.vue";
import MailingsTable from "@/components/mailings/MailingsTable.vue";
import type { Mailing } from "@/components/mailings/MailingsTable.vue";
import CreateMailingModal from "@/components/mailings/CreateMailingModal.vue";
import MailingDetailsModal from "@/components/mailings/MailingDetailsModal.vue";

// â”€â”€ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const mailings = ref<Mailing[]>([
  {
    id: "1",
    name: "ĞĞ¾Ğ²Ğ¾Ğ³Ğ¾Ğ´Ğ½ÑÑ Ğ°ĞºÑ†Ğ¸Ñ 2024",
    type: "telegram",
    status: "sent",
    subject: "ğŸ„ ĞĞ¾Ğ²Ğ¾Ğ³Ğ¾Ğ´Ğ½Ğ¸Ğµ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾ 50%!",
    message: "Ğ”Ğ¾Ñ€Ğ¾Ğ³Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹! ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ°ÑÑ‰Ğ¸Ğ¼ ĞĞ¾Ğ²Ñ‹Ğ¼ Ğ³Ğ¾Ğ´Ğ¾Ğ¼! Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾ 50% Ğ½Ğ° Ğ²ÑĞµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ´Ğ¾ 31 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ.",
    recipients: 1247,
    sent: 1247,
    delivered: 1198,
    opened: 856,
    clicked: 234,
    failed: 49,
    sentAt: "2024-01-15T10:00:00",
    createdAt: "2024-01-14T15:30:00",
    createdBy: "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
    branch: "Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¾Ñ„Ğ¸Ñ",
    targetAudience: ["vip", "active"],
  },
  {
    id: "2",
    name: "ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğµ",
    type: "max",
    status: "sent",
    message: "ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² 14:00. Ğ–Ğ´ĞµĞ¼ Ğ²Ğ°Ñ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: ÑƒĞ». Ğ›ĞµĞ½Ğ¸Ğ½Ğ°, 1. Ğ¢ĞµĞ»: +7(495)123-45-67",
    recipients: 45,
    sent: 45,
    delivered: 43,
    failed: 2,
    sentAt: "2024-01-15T16:30:00",
    createdAt: "2024-01-15T16:25:00",
    createdBy: "ĞĞ½Ğ½Ğ° Ğ¡Ğ¼Ğ¸Ñ€Ğ½Ğ¾Ğ²Ğ°",
    branch: "Ğ¤Ğ¸Ğ»Ğ¸Ğ°Ğ» â„–1",
    targetAudience: ["scheduled_visits"],
  },
  {
    id: "3",
    name: "Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ°",
    type: "email",
    status: "scheduled",
    subject: "ĞĞ¾Ğ²Ğ¾ÑÑ‚Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¸ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ",
    message: "Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½ÑƒÑ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ! Ğ’ ÑÑ‚Ğ¾Ğ¼ Ğ²Ñ‹Ğ¿ÑƒÑĞºĞµ: Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹, Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¸ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹.",
    recipients: 892,
    sent: 0,
    delivered: 0,
    failed: 0,
    scheduledAt: "2024-01-16T09:00:00",
    createdAt: "2024-01-15T14:20:00",
    createdBy: "ĞŸĞµÑ‚Ñ€ ĞĞ¸ĞºĞ¾Ğ»Ğ°ĞµĞ²",
    branch: "Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¾Ñ„Ğ¸Ñ",
    targetAudience: ["active", "newsletter_subscribers"],
  },
  {
    id: "4",
    name: "ĞĞ¿Ñ€Ğ¾Ñ ÑƒĞ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸",
    type: "telegram",
    status: "draft",
    subject: "ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ¼ ÑÑ‚Ğ°Ñ‚ÑŒ Ğ»ÑƒÑ‡ÑˆĞµ!",
    message: "Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹! ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ½Ğ°ÑˆĞ¸Ñ… ÑƒÑĞ»ÑƒĞ³. Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ¹Ğ¼ĞµÑ‚ Ğ²ÑĞµĞ³Ğ¾ 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹.",
    recipients: 0,
    sent: 0,
    delivered: 0,
    failed: 0,
    createdAt: "2024-01-15T11:45:00",
    createdBy: "ĞœĞ°Ñ€Ğ¸Ñ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ°",
    branch: "Ğ¤Ğ¸Ğ»Ğ¸Ğ°Ğ» â„–2",
    targetAudience: ["recent_clients"],
  },
  {
    id: "5",
    name: "Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ĞœĞĞšĞ¡",
    type: "max",
    status: "sending",
    subject: "Ğ’Ğ°Ğ¶Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ",
    message: "Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹! Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ°Ñ Ğ¾Ğ± Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ² Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸.",
    recipients: 234,
    sent: 156,
    delivered: 142,
    opened: 89,
    failed: 14,
    sentAt: "2024-01-15T18:00:00",
    createdAt: "2024-01-15T17:45:00",
    createdBy: "Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹ ĞšĞ¾Ğ·Ğ»Ğ¾Ğ²",
    branch: "Ğ¤Ğ¸Ğ»Ğ¸Ğ°Ğ» â„–3",
    targetAudience: ["all"],
  },
]);

const isLoading = ref(false);

// â”€â”€ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const filters = ref<TFilters>({
  search: "",
  type: "all",
  status: "all",
  branch: "all",
  dateFrom: "",
  dateTo: "",
});

const filteredMailings = computed(() => {
  let result = mailings.value;

  if (filters.value.search) {
    const q = filters.value.search.toLowerCase();
    result = result.filter(
      (m) =>
        m.name.toLowerCase().includes(q) ||
        (m.subject && m.subject.toLowerCase().includes(q)) ||
        m.message.toLowerCase().includes(q)
    );
  }

  if (filters.value.type !== "all") {
    result = result.filter((m) => m.type === filters.value.type);
  }

  if (filters.value.status !== "all") {
    result = result.filter((m) => m.status === filters.value.status);
  }

  if (filters.value.branch !== "all") {
    result = result.filter((m) => m.branch === filters.value.branch);
  }

  return result;
});

// â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const stats = computed(() => {
  const all = mailings.value;
  const totalSent = all.reduce((s, m) => s + m.sent, 0);
  const totalDelivered = all.reduce((s, m) => s + m.delivered, 0);
  const totalOpened = all.reduce((s, m) => s + (m.opened || 0), 0);

  return {
    total:           all.length,
    draft:           all.filter((m) => m.status === "draft").length,
    scheduled:       all.filter((m) => m.status === "scheduled").length,
    sent:            all.filter((m) => m.status === "sent").length,
    failed:          all.filter((m) => m.status === "failed").length,
    totalRecipients: all.reduce((s, m) => s + m.recipients, 0),
    totalSent,
    totalDelivered,
    totalOpened,
    deliveryRate:    totalSent > 0 ? Math.round((totalDelivered / totalSent) * 100) : 0,
    openRate:        totalDelivered > 0 ? Math.round((totalOpened / totalDelivered) * 100) : 0,
  };
});

// â”€â”€ ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾ĞºĞ½Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const isCreateModalOpen = ref(false);
const isDetailsModalOpen = ref(false);
const selectedMailing = ref<Mailing | null>(null);

const openDetails = (mailing: Mailing) => {
  selectedMailing.value = mailing;
  isDetailsModalOpen.value = true;
};

const closeDetails = () => {
  isDetailsModalOpen.value = false;
  selectedMailing.value = null;
};

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const handleCreate = (data: any) => {
  const newMailing: Mailing = {
    id: Date.now().toString(),
    ...data,
    recipients: 0,
    sent: 0,
    delivered: 0,
    failed: 0,
    createdAt: new Date().toISOString(),
  };
  mailings.value.unshift(newMailing);
  isCreateModalOpen.value = false;
};

const refresh = async () => {
  isLoading.value = true;
  await new Promise((r) => setTimeout(r, 800));
  isLoading.value = false;
};
</script>

<template>
  <div class="h-full overflow-hidden flex flex-col bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-4 md:px-6 py-3 flex-shrink-0">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-lg font-semibold text-gray-900">Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ¸</h1>
          <p class="text-xs text-gray-500 mt-0.5">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ°Ğ¼Ğ¸</p>
        </div>

        <div class="flex items-center gap-2 flex-shrink-0">
          <button
            @click="refresh"
            :disabled="isLoading"
            class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50"
          >
            <AppIcon name="refresh-cw" :size="14" :class="{ 'animate-spin': isLoading }" />
            <span class="hidden sm:inline">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</span>
          </button>
          <button
            @click="isCreateModalOpen = true"
            class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
          >
            <AppIcon name="plus" :size="14" />
            <span class="hidden sm:inline">ĞĞ¾Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ°</span>
            <span class="sm:hidden">ĞĞ¾Ğ²Ğ°Ñ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-5 space-y-4">
      <MailingsStats :stats="stats" />

      <MailingsFilters
        :filters="filters"
        @update:filters="(v) => (filters = v)"
      />

      <MailingsTable
        :mailings="filteredMailings"
        :loading="isLoading"
        @view-mailing="openDetails"
      />
    </div>

    <!-- Modals -->
    <CreateMailingModal
      :is-open="isCreateModalOpen"
      @close="isCreateModalOpen = false"
      @create="handleCreate"
    />

    <MailingDetailsModal
      :is-open="isDetailsModalOpen"
      :mailing="selectedMailing"
      @close="closeDetails"
    />
  </div>
</template>
